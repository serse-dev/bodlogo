"""
–§–∏–∑–∏–∫/–ú–∞—Ç–µ–º–∞—Ç–∏–∫ –ë–æ–¥–ª–æ–≥–æ “Æ“Ø—Å–≥—ç–≥—á - Gemini AI

–≠–Ω—ç—Ö“Ø“Ø –ø—Ä–æ–≥—Ä–∞–º—ã–≥ Google Gemini AI –∞—à–∏–≥–ª–∞–Ω 
—Ñ–∏–∑–∏–∫, –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏–π–Ω –±–æ–¥–ª–æ–≥–æ “Ø“Ø—Å–≥—ç—Ö—ç–¥ –∑–æ—Ä–∏—É–ª–∞–≤.
"""

import os
import streamlit as st
import google.generativeai as genai
from typing import Generator

# ------------------------------
# –•–∏—á—ç—ç–ª –±–∞ –¥—ç–¥ —Å—ç–¥–≤“Ø“Ø–¥–∏–π–Ω —Ç–æ–¥–æ—Ä—Ö–æ–π–ª–æ–ª—Ç
# ------------------------------
PHYSICS_SUBTOPICS = {
    "–ú–µ—Ö–∞–Ω–∏–∫": ["–ö–∏–Ω–µ–º–∞—Ç–∏–∫", "–î–∏–Ω–∞–º–∏–∫", "–°—Ç–∞—Ç–∏–∫", "–ì—Ä–∞–≤–∏—Ç–∞—Ü–∏", "–•”©–¥”©–ª–≥”©”©–Ω–∏–π —Ö–∞–¥–≥–∞–ª–∞—Ö —Ö—É—É–ª–∏—É–¥", "–•“Ø—á–Ω–∏–π –º–æ–º–µ–Ω—Ç"],
    "–¢–µ—Ä–º–æ–¥–∏–Ω–∞–º–∏–∫": ["–•–∏–π–Ω —Ö—É—É–ª–∏—É–¥", "–î—É–ª–∞–∞–Ω –¥–∞–º–∂—É—É–ª–∞–ª—Ç", "–î—É–ª–∞–∞–Ω—ã –º–∞—à–∏–Ω", "–≠–Ω—Ç—Ä–æ–ø–∏", "–¢–µ—Ä–º–æ–¥–∏–Ω–∞–º–∏–∫–∏–π–Ω —Ö—É—É–ª–∏—É–¥"],
    "–¶–∞—Ö–∏–ª–≥–∞–∞–Ω –±–∞ –°–æ—Ä–æ–Ω–∑": ["–¶–∞—Ö–∏–ª–≥–∞–∞–Ω –æ—Ä–æ–Ω", "–¶–∞—Ö–∏–ª–≥–∞–∞–Ω –≥“Ø–π–¥—ç–ª", "–°–æ—Ä–æ–Ω–∑–æ–Ω –æ—Ä–æ–Ω", "–¶–∞—Ö–∏–ª–≥–∞–∞–Ω —Å–æ—Ä–æ–Ω–∑–æ–Ω –∏–Ω–¥—É–∫—Ü", "RC –±–∞ RL —Ö—ç–ª—Ö—ç—ç"],
    "–î–æ–ª–≥–∏–æ–Ω –±–∞ –û–ø—Ç–∏–∫": ["–î–æ–ª–≥–∏–æ–Ω—ã —à–∏–Ω–∂ —á–∞–Ω–∞—Ä", "–ì—ç—Ä–ª–∏–π–Ω –æ–≥–∏–ª—Ç", "–ì—ç—Ä–ª–∏–π–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ—Ä–µ–Ω—Ü", "–ì—ç—Ä–ª–∏–π–Ω —Ç—É—è–ª–∑—É—É—Ä", "–•–∞–∑–∞–π–ª—Ç"],
    "–û—Ä—á–∏–Ω “Ø–µ–∏–π–Ω —Ñ–∏–∑–∏–∫": ["–ö–≤–∞–Ω—Ç –º–µ—Ö–∞–Ω–∏–∫", "–•–∞—Ä—å—Ü–∞–Ω–≥—É–π –æ–Ω–æ–ª", "–ê—Ç–æ–º—ã–Ω —Ñ–∏–∑–∏–∫", "–¶”©–º–∏–π–Ω —Ñ–∏–∑–∏–∫", "–≠–ª–µ–º–µ–Ω—Ç–∞—Ä –±”©”©–º—Å"]
}

MATH_SUBTOPICS = {
    "–ê–ª–≥–µ–±—Ä": ["–¢—ç–≥—à–∏—Ç–≥—ç–ª –±–æ–¥–æ—Ö", "–¢—ç–Ω—Ü—ç—Ç–≥—ç–ª –±–∏—à", "–û–ª–æ–Ω –≥–∏—à“Ø“Ø–Ω—Ç", "–ö–æ–º–ø–ª–µ–∫—Å —Ç–æ–æ", "–ú–∞—Ç—Ä–∏—Ü, —Ç–æ–¥–æ—Ä—Ö–æ–π–ª–æ–≥—á"],
    "–ì–µ–æ–º–µ—Ç—Ä": ["–ì—É—Ä–≤–∞–ª–∂–∏–Ω", "–î”©—Ä–≤”©–ª–∂–∏–Ω", "–¢–æ–π—Ä–æ–≥", "–ì–µ–æ–º–µ—Ç—Ä —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü", "–°—Ç–µ—Ä–µ–æ–º–µ—Ç—Ä"],
    "–¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä": ["–¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä —Ñ—É–Ω–∫—Ü", "–¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä —Ç—ç–≥—à–∏—Ç–≥—ç–ª", "–¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä —Ç—ç–Ω—Ü—ç—Ç–≥—ç–ª –±–∏—à", "–ò–Ω–≤–µ—Ä—Å —Ç—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä —Ñ—É–Ω–∫—Ü"],
    "–ú–∞—Ç–µ–º–∞—Ç–∏–∫ –∞–Ω–∞–ª–∏–∑": ["–£–ª–∞–º–∂–ª–∞–ª", "–ò–Ω—Ç–µ–≥—Ä–∞–ª", "–î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª —Ç—ç–≥—à–∏—Ç–≥—ç–ª", "–§—É–Ω–∫—Ü–∏–π–Ω —Å—É–¥–∞–ª–≥–∞–∞", "–†—è–¥"],
    "–ú–∞–≥–∞–¥–ª–∞–ª –±–∞ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫": ["–ö–æ–º–±–∏–Ω–∞—Ç–æ—Ä–∏–∫", "–ú–∞–≥–∞–¥–ª–∞–ª—ã–Ω –æ–Ω–æ–ª", "–°–∞–Ω–∞–º—Å–∞—Ä–≥“Ø–π —Ö—ç–º–∂–∏–≥–¥—ç—Ö“Ø“Ø–Ω", "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫ –¥“Ø–Ω –∞–Ω–∞–ª–∏–∑", "–†–µ–≥—Ä–µ—Å—Å–∏–π–Ω –∞–Ω–∞–ª–∏–∑"]
}

# ------------------------------
# Streamlit —Ç–æ—Ö–∏—Ä–≥–æ–æ
# ------------------------------
st.set_page_config(
    page_title="–§–∏–∑–∏–∫/–ú–∞—Ç–µ–º–∞—Ç–∏–∫ –ë–æ–¥–ª–æ–≥–æ “Æ“Ø—Å–≥—ç–≥—á",
    page_icon="üßÆ",
    layout="centered",
    initial_sidebar_state="expanded"
)

# ------------------------------
# –•—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
# ------------------------------
st.title("üßÆ –§–∏–∑–∏–∫/–ú–∞—Ç–µ–º–∞—Ç–∏–∫ –ë–æ–¥–ª–æ–≥–æ “Æ“Ø—Å–≥—ç–≥—á")
st.caption("Google Gemini AI –∞—à–∏–≥–ª–∞–Ω —Å–æ–Ω–≥–æ—Å–æ–Ω —Å—ç–¥–≤—ç—ç—Ä —à–∏–Ω—ç –±–æ–¥–ª–æ–≥–æ “Ø“Ø—Å–≥—ç–Ω—ç")

# ------------------------------
# API —Ç“Ø–ª—Ö“Ø“Ø—Ä–∏–π–≥ —Ç–æ—Ö–∏—Ä—É—É–ª–∞—Ö
# ------------------------------
# Environment variable-–∞–∞—Å —ç—Ö–ª—ç—ç–¥ —à–∞–ª–≥–∞—Ö
google_api_key = os.environ.get("GOOGLE_API_KEY")

# –•—ç—Ä—ç–≤ environment variable –±–∞–π—Ö–≥“Ø–π –±–æ–ª sidebar-–∞–∞—Å –∞–≤–∞—Ö
if not google_api_key:
    with st.sidebar:
        google_api_key = st.text_input("Google API Key", type="password", 
                                     help="Google AI Studio-–∞–∞—Å –∞–≤–∞—Ö API —Ç“Ø–ª—Ö“Ø“Ø—Ä—ç—ç –æ—Ä—É—É–ª–Ω–∞ —É—É")

# API —Ç“Ø–ª—Ö“Ø“Ø—Ä –±–∞–π–≥–∞–∞ —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞—Ö
DEMO_MODE = not bool(google_api_key)

# API —Ç“Ø–ª—Ö“Ø“Ø—Ä–∏–π–≥ —Ç–æ—Ö–∏—Ä—É—É–ª–∞—Ö
if google_api_key:
    try:
        genai.configure(api_key=google_api_key)
    except Exception as e:
        st.error(f"API —Ç“Ø–ª—Ö“Ø“Ø—Ä —Ç–æ—Ö–∏—Ä—É—É–ª–∞—Ö “Ø–µ–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞: {e}")
        DEMO_MODE = True

# ------------------------------
# –•–∞–∂—É—É —Å–∞–º–±–∞—Ä - –¢–æ—Ö–∏—Ä–≥–æ–æ
# ------------------------------
with st.sidebar:
    st.header("‚öôÔ∏è –¢–æ—Ö–∏—Ä–≥–æ–æ")
    
    if DEMO_MODE:
        st.warning("API —Ç“Ø–ª—Ö“Ø“Ø—Ä –æ—Ä—É—É–ª–∞–∞–≥“Ø–π —ç—Å–≤—ç–ª –±—É—Ä—É—É –±–∞–π–Ω–∞. –î–µ–º–æ –≥–æ—Ä–∏–º–¥ –∞–∂–∏–ª–ª–∞–∂ –±–∞–π–Ω–∞.")
    else:
        st.success("API —Ç“Ø–ª—Ö“Ø“Ø—Ä –∞–º–∂–∏–ª—Ç—Ç–∞–π —Ç–æ—Ö–∏—Ä—É—É–ª–∞–≥–¥—Å–∞–Ω")
    
    # –•–∏—á—ç—ç–ª —Å–æ–Ω–≥–æ—Ö
    subject = st.selectbox(
        "–•–∏—á—ç—ç–ª",
        ["–§–∏–∑–∏–∫", "–ú–∞—Ç–µ–º–∞—Ç–∏–∫"],
        index=0
    )
    
    # –ì–æ–ª —Å—ç–¥—ç–≤ —Å–æ–Ω–≥–æ—Ö
    if subject == "–§–∏–∑–∏–∫":
        main_topic = st.selectbox(
            "–ì–æ–ª —Å—ç–¥—ç–≤",
            list(PHYSICS_SUBTOPICS.keys()),
            index=0
        )
        subtopic = st.selectbox(
            "–î—ç–¥ —Å—ç–¥—ç–≤",
            PHYSICS_SUBTOPICS[main_topic],
            index=0
        )
    else:
        main_topic = st.selectbox(
            "–ì–æ–ª —Å—ç–¥—ç–≤",
            list(MATH_SUBTOPICS.keys()),
            index=0
        )
        subtopic = st.selectbox(
            "–î—ç–¥ —Å—ç–¥—ç–≤",
            MATH_SUBTOPICS[main_topic],
            index=0
        )
    
    # “Æ“Ø—Å–≥—ç—Ö —Ç–æ–æ
    problem_count = st.slider("“Æ“Ø—Å–≥—ç—Ö –±–æ–¥–ª–æ–≥—ã–Ω —Ç–æ–æ", 1, 20, 10)
    
    # –®–∏–π–¥ –æ—Ä—É—É–ª–∞—Ö —ç—Å—ç—Ö
    include_solutions = st.checkbox("–®–∏–π–¥ –æ—Ä—É—É–ª–∞—Ö", value=True)
    
    # –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä
    temperature = st.slider(
        "–°–∞–Ω–∞–∞—á–∏–ª–≥–∞ (temperature)", 
        0.0, 1.0, 0.7, 0.1,
        help="”®–Ω–¥”©—Ä –±–∞–π—Ö —Ç—É—Å–∞–º –∏–ª“Ø“Ø –±“Ø—Ç—ç—ç–ª—á –±–æ–ª–æ–≤—á –±–∞—Ç–∞–ª–≥–∞–∞–∂—Å–∞–Ω –±–∞–π–¥–∞–ª –±—É—É—Ä–Ω–∞"
    )
    
    st.markdown("---")
    st.subheader("üîÑ –ñ–∏—à—ç—ç –±–æ–¥–ª–æ–≥–æ")
    
    # –ñ–∏—à—ç—ç –±–æ–¥–ª–æ–≥—É—É–¥
    if subject == "–§–∏–∑–∏–∫":
        if main_topic == "–ú–µ—Ö–∞–Ω–∏–∫":
            if subtopic == "–ö–∏–Ω–µ–º–∞—Ç–∏–∫":
                example_problem = "–ú–∞—à–∏–Ω 72 –∫–º/—Ü —Ö—É—Ä–¥—Ç–∞–π —è–≤–∂ –±–∞–π–≥–∞–∞–¥ 4 —Å–µ–∫—É–Ω–¥—ã–Ω –¥–æ—Ç–æ—Ä –∑–æ–≥—Å—Å–æ–Ω. –ú–∞—à–∏–Ω—ã —Ö—É—Ä–¥–∞—Ç–≥–∞–ª –±–æ–ª–æ–Ω –∑–æ–≥—Å–æ—Ö –∑–∞–º –Ω—å —Ö—ç–¥ –≤—ç?"
            elif subtopic == "–î–∏–Ω–∞–º–∏–∫":
                example_problem = "15¬∞ –Ω–∞–ª—É—É —Ö–∞–≤—Ç–≥–∞–π –¥—ç—ç—Ä 2 –∫–≥ –º–∞—Å—Å—Ç–∞–π –±–∏–µ—Ç–∏–π–≥ “Ø—Ä—ç–ª—Ç–≥“Ø–π –æ—Ä—á–∏–Ω–¥ —á–∏—Ä—ç—Ö—ç–¥ –±–∏–µ–¥ “Ø–π–ª—á–ª—ç—Ö —Ç–∞—Ç–∞—Ö —Ö“Ø—á –±–æ–ª–æ–Ω –Ω–∞–ª—É—É–≥–∏–π–Ω –¥–∞–≥—É—É—Ö —Ö—É—Ä–¥–∞—Ç–≥–∞–ª—ã–≥ –æ–ª. g=9.8 –º/—Å¬≤."
            else:
                example_problem = "5 –∫–≥ –º–∞—Å—Å—Ç–∞–π –±–∏–µ 10 –º/—Å —Ö—É—Ä–¥—Ç–∞–π–≥–∞–∞—Ä —Ö”©–¥”©–ª–∂ –±–∞–π–≥–∞–∞–¥ 2 –∫–≥ –º–∞—Å—Å—Ç–∞–π —Ç–∞–π–≤–∞–Ω –±–∞–π–≥–∞–∞ –±–∏–µ—Ç—ç–π –º”©—Ä–≥”©–ª–¥”©–≤. –ú”©—Ä–≥”©–ª–¥”©”©–Ω —É—è–Ω —Ö–∞—Ç–∞–Ω –±–æ–ª —É–≥—Å–∞—Ä—Å–∞–Ω –±–∏–µ–∏–π–Ω —Ö—É—Ä–¥—ã–≥ –æ–ª."
        elif main_topic == "–¶–∞—Ö–∏–ª–≥–∞–∞–Ω –±–∞ –°–æ—Ä–æ–Ω–∑":
            example_problem = "10 Œ© —ç—Å—ç—Ä–≥“Ø“Ø—Ü—ç–ª—Ç—ç–π –¥–∞–º–∂—É—É–ª–∞–≥—á–∏–¥ 12 –í —Ö“Ø—á–¥—ç–ª –∑–∞–ª–≥–∞—Ö–∞–¥ –≥“Ø–π–¥—ç–ª —Ö—ç–¥ –≤—ç? –î–∞–º–∂—É—É–ª–∞–≥—á–∞–∞—Ä 5 –º–∏–Ω—É—Ç —è–≤–∞—Ö–∞–¥ —è–ª–≥–∞—Ä–∞—Ö –¥—É–ª–∞–∞–Ω—ã —Ö—ç–º–∂—ç—ç–≥ –æ–ª."
        else:
            example_problem = "100 –≥ –º–∞—Å—Å—Ç–∞–π –±–∏–µ–∏–π–Ω —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä 20¬∞C-–∞–∞—Å 80¬∞C —Ö“Ø—Ä—Ç—ç–ª —Ö–∞–ª–∞–∞—Ö–∞–¥ —à–∞–∞—Ä–¥–∞–≥–¥–∞—Ö –¥—É–ª–∞–∞–Ω—ã —Ö—ç–º–∂—ç—ç–≥ –æ–ª. –ë–∏–µ–∏–π–Ω —Ö—É–≤–∏–π–Ω –¥—É–ª–∞–∞–Ω –±–∞–≥—Ç–∞–∞–º–∂ 0.5 J/g¬∞C –±–∞–π–Ω–∞."
    else:
        if main_topic == "–ê–ª–≥–µ–±—Ä":
            example_problem = "x¬≤ - 5x + 6 = 0 —Ç—ç–≥—à–∏—Ç–≥—ç–ª–∏–π–Ω –±–æ–¥–∏—Ç —à–∏–π–¥–∏–π–≥ –æ–ª. –ú”©–Ω —è–∑–≥—É—É—Ä—É—É–¥—ã–Ω –Ω–∏–π–ª–±—ç—Ä –±–∞ “Ø—Ä–∂–≤—ç—Ä–∏–π–≥ –æ–ª."
        elif main_topic == "–ì–µ–æ–º–µ—Ç—Ä":
            example_problem = "–ì—É—Ä–≤–∞–ª–∂–Ω—ã —Ç–∞–ª—É—É–¥ –Ω—å 6 —Å–º, 8 —Å–º, 10 —Å–º –±–∞–π–Ω–∞. –≠–Ω—ç –≥—É—Ä–≤–∞–ª–∂–∏–Ω —Ç—ç–≥—à ”©–Ω—Ü”©–≥—Ç —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞–∞–¥, —Ç–∞–ª–±–∞–π–≥ –Ω—å –æ–ª."
        elif main_topic == "–ú–∞—Ç–µ–º–∞—Ç–∏–∫ –∞–Ω–∞–ª–∏–∑":
            example_problem = "y = 2x¬≤ - 4x + 1 —Ñ—É–Ω–∫—Ü–∏–π–Ω —É–ª–∞–º–∂–ª–∞–ª—ã–≥ –æ–ª–∂, —ç–∫—Å—Ç—Ä–µ–º—É–º —Ü—ç–≥“Ø“Ø–¥–∏–π–≥ —Ç–æ–¥–æ—Ä—Ö–æ–π–ª."
        else:
            example_problem = "–ù—ç–≥ —à–æ–æ —à–∏–¥—ç—Ö—ç–¥: a) 4-”©”©—Å –∏—Ö —Ç–æ–æ –±—É—É—Ö –º–∞–≥–∞–¥–ª–∞–ª, b) —Ç—ç–≥—à —Ç–æ–æ –±—É—É—Ö –º–∞–≥–∞–¥–ª–∞–ª—ã–≥ –æ–ª."
    
    if st.button("–ñ–∏—à—ç—ç–≥—ç—ç—Ä –¥“Ø“Ø—Ä–≥—ç—Ö"):
        st.session_state["problem_text"] = example_problem
        st.rerun()

# ------------------------------
# –ì–æ–ª –∫–æ–Ω—Ç–µ–Ω—Ç —Ö—ç—Å—ç–≥
# ------------------------------
st.subheader(f"{subject} - {main_topic}: {subtopic}")

# –ë–æ–¥–ª–æ–≥–æ –æ—Ä—É—É–ª–∞—Ö —Ç–∞–ª–±–∞—Ä
problem_text = st.text_area(
    "–ë–æ–¥–ª–æ–≥—ã–Ω –∂–∏—à—ç—ç –æ—Ä—É—É–ª–∞—Ö",
    height=150,
    key="problem_text",
    placeholder="”®”©—Ä–∏–π–Ω –±–æ–¥–ª–æ–≥–æ –æ—Ä—É—É–ª–∞—Ö —ç—Å–≤—ç–ª –¥—ç—ç—Ä—Ö '–ñ–∏—à—ç—ç–≥—ç—ç—Ä –¥“Ø“Ø—Ä–≥—ç—Ö' —Ç–æ–≤—á–∏–π–≥ –¥–∞—Ä–Ω–∞ —É—É",
    help="–ñ–∏—à—ç—ç –±–æ–¥–ª–æ–≥–æ –æ—Ä—É—É–ª–∞—Ö–¥–∞–∞ –±“Ø—Ä—ç–Ω –¥“Ø“Ø—Ä—ç–Ω, –æ–π–ª–≥–æ–º–∂—Ç–æ–π –±–∞–π–ª–≥–∞—Ö –Ω—å –∏–ª“Ø“Ø —Å–∞–π–Ω “Ø—Ä –¥“Ø–Ω ”©–≥–Ω”©"
)

# –¢–æ–≤—á–ª—É—É—Ä—É—É–¥
col1, col2, col3 = st.columns([1, 1, 2])
with col1:
    generate_btn = st.button("üöÄ –ë–æ–¥–ª–æ–≥–æ “Ø“Ø—Å–≥—ç—Ö", type="primary", use_container_width=True)
with col2:
    clear_btn = st.button("üßπ –¶—ç–≤—ç—Ä–ª—ç—Ö", use_container_width=True)
with col3:
    st.info(f"{problem_count} –±–æ–¥–ª–æ–≥–æ “Ø“Ø—Å–≥—ç–Ω—ç")

if clear_btn:
    st.session_state["problem_text"] = ""
    st.rerun()

# ------------------------------
# –§—É–Ω–∫—Ü—É—É–¥
# ------------------------------
def setup_gemini():
    """Gemini AI —Ç–æ—Ö–∏—Ä—É—É–ª–∞—Ö"""
    try:
        if google_api_key:
            genai.configure(api_key=google_api_key)
            return genai.GenerativeModel('gemini-pro')
        else:
            st.error("API —Ç“Ø–ª—Ö“Ø“Ø—Ä –æ—Ä—É—É–ª–∞–∞–≥“Ø–π –±–∞–π–Ω–∞. –¢–æ—Ö–∏—Ä–≥–æ–æ —Ö—ç—Å–≥—ç—ç—Å API —Ç“Ø–ª—Ö“Ø“Ø—Ä—ç—ç –æ—Ä—É—É–ª–Ω–∞ —É—É.")
            return None
    except Exception as e:
        st.error(f"Gemini —Ç–æ—Ö–∏—Ä—É—É–ª–∞—Ö “Ø–µ–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞: {e}")
        return None

def generate_problems_prompt(user_problem: str, count: int = 10, with_solutions: bool = True) -> str:
    """–ë–æ–¥–ª–æ–≥–æ “Ø“Ø—Å–≥—ç—Ö prompt –±—ç–ª—Ç–≥—ç—Ö"""
    return f"""
–¢–∞ –±–æ–ª {subject} —Ö–∏—á—ç—ç–ª–∏–π–Ω {main_topic} —Å—ç–¥–≤–∏–π–Ω {subtopic} –¥—ç–¥ —Å—ç–¥—ç–≤—Ç –º—ç—Ä–≥—ç—à—Å—ç–Ω –±–∞–≥—à.

–î–ê–ê–õ–ì–ê–í–ê–†:
- –î–∞—Ä–∞–∞—Ö –∂–∏—à—ç—ç –±–æ–¥–ª–æ–≥–æ—Ç–æ–π –∏–∂–∏–ª —Ç“Ø–≤—à–∏–Ω, –∏–∂–∏–ª —Ç”©—Ä–ª–∏–π–Ω {count} —à–∏–Ω—ç –±–æ–¥–ª–æ–≥–æ “Ø“Ø—Å–≥—ç.
- –ë–æ–¥–ª–æ–≥–æ –±“Ø—Ä ”©”©—Ä ”©”©—Ä –Ω”©—Ö—Ü”©–ª, ”©–≥”©–≥–¥”©–ª—Ç—ç–π –±–∞–π—Ö.
- –ë–æ–¥–ª–æ–≥–æ –Ω—å –æ–π–ª–≥–æ–º–∂—Ç–æ–π, –Ω—ç–≥ —É—Ç–≥–∞—Ç–∞–π, —à–∏–π–¥–≤—ç—Ä–ª—ç—Ö –±–æ–ª–æ–º–∂—Ç–æ–π –±–∞–π—Ö.
- –•—ç—Ä—ç–≥–ª—ç–≥–¥—ç—Ö –Ω—ç–≥–∂, —Ç–æ–º—å—ë–æ –∑”©–≤ –±–∞–π—Ö.

–ñ–ò–®–≠–≠ –ë–û–î–õ–û–ì–û:
{user_problem}

“Æ“Æ–°–ì–≠–• –ë–û–î–õ–û–ì–û–ù–£–£–î:
{count} —à–∏–Ω—ç –±–æ–¥–ª–æ–≥–æ “Ø“Ø—Å–≥—ç. –ë–æ–¥–ª–æ–≥–æ –±“Ø—Ä–∏–π–≥ –¥–∞—Ä–∞–∞—Ö —Ñ–æ—Ä–º–∞—Ç—Ç–∞–π–≥–∞–∞—Ä –≥–∞—Ä–≥–∞:

1. **–ë–æ–¥–ª–æ–≥–æ:** [–±–æ–¥–ª–æ–≥—ã–Ω —Ç–µ–∫—Å—Ç]
   **–°—ç–¥—ç–≤:** {main_topic} - {subtopic}
   {"**–®–∏–π–¥:** [–±–æ–¥–ª–æ–≥—ã–Ω —à–∏–π–¥—ç–ª]" if with_solutions else ""}

–ë“Ø—Ö –±–æ–¥–ª–æ–≥—É—É–¥—ã–≥ –ú–æ–Ω–≥–æ–ª —Ö—ç–ª—ç—ç—Ä “Ø“Ø—Å–≥—ç.
"""

def stream_gemini_response(prompt: str) -> Generator[str, None, None]:
    """Gemini-–∏–π–Ω —Ö–∞—Ä–∏—É–≥ stream —Ö—ç–ª–±—ç—Ä—ç—ç—Ä –∞–≤–∞—Ö"""
    try:
        model = setup_gemini()
        if not model:
            yield "API —Ç“Ø–ª—Ö“Ø“Ø—Ä –±—É—Ä—É—É —ç—Å–≤—ç–ª –æ—Ä—É—É–ª–∞–∞–≥“Ø–π –±–∞–π–Ω–∞."
            return
            
        response = model.generate_content(
            prompt,
            stream=True,
            generation_config=genai.types.GenerationConfig(
                temperature=temperature,
                max_output_tokens=2048,
            )
        )
        
        for chunk in response:
            yield chunk.text
                
    except Exception as e:
        yield f"–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞: {str(e)}"

def show_demo_problems():
    """–î–µ–º–æ –≥–æ—Ä–∏–º–¥ –∂–∏—à—ç—ç –±–æ–¥–ª–æ–≥–æ —Ö–∞—Ä—É—É–ª–∞—Ö"""
    st.info("""
    **–î–µ–º–æ –≥–æ—Ä–∏–º–¥ –∞–∂–∏–ª–ª–∞–∂ –±–∞–π–Ω–∞.** 
    
    –ë–æ–¥–∏—Ç –±–æ–¥–ª–æ–≥–æ “Ø“Ø—Å–≥—ç—Ö–∏–π–Ω —Ç—É–ª–¥ –∑“Ø“Ø–Ω —Ç–∞–ª—ã–Ω —Ç–æ—Ö–∏—Ä–≥–æ–æ–Ω—ã —Ö—ç—Å–≥—ç—ç—Å Google API Key –æ—Ä—É—É–ª–Ω–∞ —É—É. 
    API Key –∞–≤–∞—Ö—ã–Ω —Ç—É–ª–¥ [Google AI Studio](https://makersuite.google.com/app/apikey) —Ä—É—É –∑–æ—á–ª–æ–æ—Ä–æ–π.
    """)
    
    st.subheader("“Æ“Ø—Å–≥—ç—Å—ç–Ω –±–æ–¥–ª–æ–≥—É—É–¥ (–∂–∏—à—ç—ç):")
    
    if subject == "–§–∏–∑–∏–∫":
        if main_topic == "–ú–µ—Ö–∞–Ω–∏–∫" and subtopic == "–î–∏–Ω–∞–º–∏–∫":
            demo_content = """
1. **–ë–æ–¥–ª–æ–≥–æ:** 30¬∞ –Ω–∞–ª—É—É —Ö–∞–≤—Ç–≥–∞–π –¥—ç—ç—Ä 3 –∫–≥ –º–∞—Å—Å—Ç–∞–π –±–∏–µ—Ç–∏–π–≥ –¥—ç—ç—à —á–∏—Ä–∂ –±–∞–π–Ω–∞. “Æ—Ä—ç–ª—Ç–∏–π–Ω –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç 0.2 –±–æ–ª –±–∏–µ—Ç–∏–π–Ω —Ö—É—Ä–¥–∞—Ç–≥–∞–ª—ã–≥ –æ–ª. g=9.8 –º/—Å¬≤.
   **–°—ç–¥—ç–≤:** –ú–µ—Ö–∞–Ω–∏–∫ - –î–∏–Ω–∞–º–∏–∫
   **–®–∏–π–¥:** –•“Ø—á–¥–∏–π–Ω –¥–∏–∞–≥—Ä–∞–º–º –∑—É—Ä–∂, –ù—å—é—Ç–æ–Ω—ã —Ö—É—É–ª–∏–π–≥ —Ö—ç—Ä—ç–≥–ª—ç–Ω –±–æ–¥–Ω–æ. –•–∞—Ä–∏—É: 3.2 –º/—Å¬≤

2. **–ë–æ–¥–ª–æ–≥–æ:** 5 –∫–≥ –º–∞—Å—Å—Ç–∞–π –±–∏–µ 20 –ù —Ö“Ø—á–Ω–∏–π –Ω”©–ª”©”©–≥”©”©—Ä —Ö”©–¥”©–ª–∂ –±–∞–π–Ω–∞. 10 —Å–µ–∫—É–Ω–¥—ã–Ω –¥–∞—Ä–∞–∞ –±–∏–µ–∏–π–Ω —Ö—É—Ä–¥ —Ö—ç–¥ –±–æ–ª–æ—Ö –≤—ç? –ê–Ω—Ö–Ω—ã —Ö—É—Ä–¥ 0 –±–∞–π–Ω–∞.
   **–°—ç–¥—ç–≤:** –ú–µ—Ö–∞–Ω–∏–∫ - –î–∏–Ω–∞–º–∏–∫
   **–®–∏–π–¥:** a = F/m = 4 –º/—Å¬≤, v = at = 40 –º/—Å

3. **–ë–æ–¥–ª–æ–≥–æ:** 0.5 –∫–≥ –º–∞—Å—Å—Ç–∞–π –±”©–º–±”©–≥ 10 –º/—Å —Ö—É—Ä–¥—Ç–∞–π–≥–∞–∞—Ä —Ö”©–¥”©–ª–∂ –±–∞–π–≥–∞–∞–¥ —Ö–∞–Ω—ã–≥ –º”©—Ä–≥”©–∂ 8 –º/—Å —Ö—É—Ä–¥—Ç–∞–π–≥–∞–∞—Ä –±—É—Ü–∞–Ω –æ–π–≤. –ú”©—Ä–≥”©–ª–¥”©”©–Ω–∏–π “Ø–µ–∏–π–Ω —Ö“Ø—á–Ω–∏–π –∏–º–ø—É–ª—å—Å–∏–π–≥ –æ–ª.
   **–°—ç–¥—ç–≤:** –ú–µ—Ö–∞–Ω–∏–∫ - –î–∏–Ω–∞–º–∏–∫
   **–®–∏–π–¥:** –ò–º–ø—É–ª—å—Å = mŒîv = 0.5 * (10 - (-8)) = 9 –ù¬∑—Å
"""
        else:
            demo_content = """
1. **–ë–æ–¥–ª–æ–≥–æ:** 200 –û–º —ç—Å—ç—Ä–≥“Ø“Ø—Ü—ç–ª—Ç—ç–π —Ä–µ–∑–∏—Å—Ç–æ—Ä –¥—ç—ç—Ä 24 –í —Ö“Ø—á–¥—ç–ª ”©–≥”©–≥–¥—Å”©–Ω. –†–µ–∑–∏—Å—Ç–æ—Ä–æ–æ—Ä –≥“Ø–π—Ö –≥“Ø–π–¥–ª–∏–π–Ω —Ö“Ø—á–∏–π–≥ –æ–ª.
   **–°—ç–¥—ç–≤:** –¶–∞—Ö–∏–ª–≥–∞–∞–Ω –±–∞ –°–æ—Ä–æ–Ω–∑ - –¶–∞—Ö–∏–ª–≥–∞–∞–Ω –≥“Ø–π–¥—ç–ª
   **–®–∏–π–¥:** –û–º—ã–Ω —Ö—É—É–ª–∏–∞—Ä I = V/R = 24/200 = 0.12 –ê

2. **–ë–æ–¥–ª–æ–≥–æ:** 0.5 –º–¢–ª –∏–Ω–¥—É–∫—Ü—Ç—ç–π —Å–æ—Ä–æ–Ω–∑–æ–Ω –æ—Ä–æ–Ω –¥–æ—Ç–æ—Ä 30 —Å–º —É—Ä—Ç—Ç–∞–π –¥–∞–º–∂—É—É–ª–∞–≥—á 10 –º/—Å —Ö—É—Ä–¥—Ç–∞–π–≥–∞–∞—Ä —Ö”©–¥”©–ª–∂ –±–∞–π–Ω–∞. –î–∞–º–∂—É—É–ª–∞–≥—á–∏–π–Ω “Ø“Ø—Å–≥—ç—Ö —Ö“Ø—á–¥—ç–ª–∏–π–≥ –æ–ª.
   **–°—ç–¥—ç–≤:** –¶–∞—Ö–∏–ª–≥–∞–∞–Ω –±–∞ –°–æ—Ä–æ–Ω–∑ - –¶–∞—Ö–∏–ª–≥–∞–∞–Ω —Å–æ—Ä–æ–Ω–∑–æ–Ω –∏–Ω–¥—É–∫—Ü
   **–®–∏–π–¥:** Œµ = B*l*v = 0.0005 * 0.3 * 10 = 0.0015 –í

3. **–ë–æ–¥–ª–æ–≥–æ:** 10 ŒºF –±–∞ 20 ŒºF –∫–æ–Ω–¥–µ–Ω—Å–∞—Ç–æ—Ä—É—É–¥—ã–≥ —Ü—É–≤–∞–∞ —Ö–æ–ª–±–æ—Å–æ–Ω. –ù–∏–π—Ç –±–∞–≥—Ç–∞–∞–º–∂ —Ö—ç–¥ –≤—ç?
   **–°—ç–¥—ç–≤:** –¶–∞—Ö–∏–ª–≥–∞–∞–Ω –±–∞ –°–æ—Ä–æ–Ω–∑ - –¶–∞—Ö–∏–ª–≥–∞–∞–Ω –≥“Ø–π–¥—ç–ª
   **–®–∏–π–¥:** 1/C = 1/10 + 1/20 = 3/20, C = 20/3 ‚âà 6.67 ŒºF
"""
    else:
        if main_topic == "–ê–ª–≥–µ–±—Ä":
            demo_content = """
1. **–ë–æ–¥–ª–æ–≥–æ:** 2x¬≤ - 8x + 6 = 0 —Ç—ç–≥—à–∏—Ç–≥—ç–ª–∏–π–Ω —à–∏–π–¥–∏–π–≥ –æ–ª.
   **–°—ç–¥—ç–≤:** –ê–ª–≥–µ–±—Ä - –¢—ç–≥—à–∏—Ç–≥—ç–ª –±–æ–¥–æ—Ö
   **–®–∏–π–¥:** x = 1, x = 3

2. **–ë–æ–¥–ª–æ–≥–æ:** (x-3)(x+2) = 10 —Ç—ç–≥—à–∏—Ç–≥—ç–ª–∏–π–≥ –±–æ–¥.
   **–°—ç–¥—ç–≤:** –ê–ª–≥–µ–±—Ä - –¢—ç–≥—à–∏—Ç–≥—ç–ª –±–æ–¥–æ—Ö
   **–®–∏–π–¥:** x¬≤ - x - 6 = 10 ‚Üí x¬≤ - x - 16 = 0 ‚Üí x = (1 ¬± ‚àö65)/2

3. **–ë–æ–¥–ª–æ–≥–æ:** –î–∞—Ä–∞–∞—Ö —Ç—ç–Ω—Ü—ç—Ç–≥—ç–ª –±–∏—à–∏–π–≥ –±–æ–¥: 3x - 7 > 2x + 5
   **–°—ç–¥—ç–≤:** –ê–ª–≥–µ–±—Ä - –¢—ç–Ω—Ü—ç—Ç–≥—ç–ª –±–∏—à
   **–®–∏–π–¥:** 3x - 2x > 5 + 7 ‚Üí x > 12
"""
        else:
            demo_content = """
1. **–ë–æ–¥–ª–æ–≥–æ:** y = x¬≥ - 3x¬≤ + 2 —Ñ—É–Ω–∫—Ü–∏–π–Ω —É–ª–∞–º–∂–ª–∞–ª—ã–≥ –æ–ª–∂, —ç–∫—Å—Ç—Ä–µ–º—É–º —Ü—ç–≥“Ø“Ø–¥–∏–π–≥ —Ç–æ–¥–æ—Ä—Ö–æ–π–ª.
   **–°—ç–¥—ç–≤:** –ú–∞—Ç–µ–º–∞—Ç–∏–∫ –∞–Ω–∞–ª–∏–∑ - –£–ª–∞–º–∂–ª–∞–ª
   **–®–∏–π–¥:** y' = 3x¬≤ - 6x = 3x(x-2), x=0 –±–∞ x=2 —Ü—ç–≥“Ø“Ø–¥—ç–¥ —ç–∫—Å—Ç—Ä–µ–º—É–º—Ç–∞–π

2. **–ë–æ–¥–ª–æ–≥–æ:** ‚à´(2x + 3) dx –∏–Ω—Ç–µ–≥—Ä–∞–ª—ã–≥ –±–æ–¥.
   **–°—ç–¥—ç–≤:** –ú–∞—Ç–µ–º–∞—Ç–∏–∫ –∞–Ω–∞–ª–∏–∑ - –ò–Ω—Ç–µ–≥—Ä–∞–ª
   **–®–∏–π–¥:** x¬≤ + 3x + C

3. **–ë–æ–¥–ª–æ–≥–æ:** f(x) = x¬≤ - 4x + 4 —Ñ—É–Ω–∫—Ü–∏–π–Ω –≥—Ä–∞—Ñ–∏–∫–∏–π–Ω x=3 —Ü—ç–≥—Ç —Ç–∞—Ç—Å–∞–Ω —à“Ø—Ä–≥—ç–≥—á–∏–π–Ω —Ç—ç–≥—à–∏—Ç–≥—ç–ª–∏–π–≥ –æ–ª.
   **–°—ç–¥—ç–≤:** –ú–∞—Ç–µ–º–∞—Ç–∏–∫ –∞–Ω–∞–ª–∏–∑ - –£–ª–∞–º–∂–ª–∞–ª
   **–®–∏–π–¥:** f'(x) = 2x - 4, f'(3) = 2, f(3) = 1 ‚Üí y - 1 = 2(x - 3)
"""
    
    st.markdown(demo_content)
    st.warning("–≠–Ω—ç –±–æ–ª –∑”©–≤—Ö”©–Ω –¥–µ–º–æ –∂–∏—à—ç—ç —é–º. –ë–æ–¥–∏—Ç –±–æ–¥–ª–æ–≥–æ “Ø“Ø—Å–≥—ç—Ö–∏–π–Ω —Ç—É–ª–¥ API —Ç“Ø–ª—Ö“Ø“Ø—Ä—ç—ç –æ—Ä—É—É–ª–Ω–∞ —É—É.")

# ------------------------------
# “Æ–Ω–¥—Å—ç–Ω –ª–æ–≥–∏–∫
# ------------------------------
if generate_btn:
    if not problem_text.strip():
        st.warning("–ë–æ–¥–ª–æ–≥—ã–Ω –∂–∏—à—ç—ç –æ—Ä—É—É–ª–Ω–∞ —É—É")
    else:
        if DEMO_MODE:
            show_demo_problems()
        else:
            with st.spinner("–ë–æ–¥–ª–æ–≥—É—É–¥—ã–≥ “Ø“Ø—Å–≥—ç–∂ –±–∞–π–Ω–∞..."):
                prompt = generate_problems_prompt(problem_text, problem_count, include_solutions)
                
                st.subheader("“Æ“Ø—Å–≥—ç—Å—ç–Ω –±–æ–¥–ª–æ–≥—É—É–¥:")
                response_area = st.empty()
                
                full_response = ""
                for chunk in stream_gemini_response(prompt):
                    full_response += chunk
                    response_area.markdown(full_response)
                
                # “Æ—Ä –¥“Ø–Ω–≥ —Ö–∞–¥–≥–∞–ª–∞—Ö
                st.session_state["last_response"] = full_response
                
                # –¢–∞—Ç–∞–∂ –∞–≤–∞—Ö –±–æ–ª–æ–º–∂
                st.download_button(
                    label="üì• “Æ—Ä –¥“Ø–Ω–≥ —Ç–∞—Ç–∞–∂ –∞–≤–∞—Ö",
                    data=full_response,
                    file_name=f"{subject}_{main_topic}_{subtopic}_–±–æ–¥–ª–æ–≥—É—É–¥.md",
                    mime="text/markdown"
                )

# ------------------------------
# –ú—ç–¥—ç—ç–ª—ç–ª —Ö—ç—Å—ç–≥
# ------------------------------
st.markdown("---")
expander = st.expander("‚ÑπÔ∏è –ó–∞–∞–≤–∞—Ä")
expander.markdown("""
### –ü—Ä–æ–≥—Ä–∞–º—ã–≥ —Ö—ç—Ä—Ö—ç–Ω –∞—à–∏–≥–ª–∞—Ö –≤—ç:

1. **API —Ç“Ø–ª—Ö“Ø“Ø—Ä –æ—Ä—É—É–ª–∞—Ö**: 
   - [Google AI Studio](https://makersuite.google.com/app/apikey) —Ö—É—É–¥–∞—Å —Ä—É—É –æ—Ä–Ω–æ
   - Google –±“Ø—Ä—Ç–≥—ç–ª—ç—ç—Ä—ç—ç –Ω—ç–≤—Ç—ç—Ä–Ω—ç
   - "Create API Key" —Ç–æ–≤—á–∏–π–≥ –¥–∞—Ä–∂ —à–∏–Ω—ç —Ç“Ø–ª—Ö“Ø“Ø—Ä “Ø“Ø—Å–≥—ç–Ω—ç
   - “Æ“Ø—Å–≥—ç—Å—ç–Ω —Ç“Ø–ª—Ö“Ø“Ø—Ä—ç—ç —Ö—É—É–ª–∂, –∑“Ø“Ø–Ω —Ç–∞–ª—ã–Ω "Google API Key" —Ç–∞–ª–±–∞—Ä—Ç –æ—Ä—É—É–ª–Ω–∞

2. **–•–∏—á—ç—ç–ª —Å–æ–Ω–≥–æ—Ö**: –§–∏–∑–∏–∫ —ç—Å–≤—ç–ª –ú–∞—Ç–µ–º–∞—Ç–∏–∫ —Ö–∏—á—ç—ç–ª —Å–æ–Ω–≥–æ–Ω–æ

3. **–°—ç–¥—ç–≤ —Å–æ–Ω–≥–æ—Ö**: –ì–æ–ª —Å—ç–¥—ç–≤ –±–æ–ª–æ–Ω –¥—ç–¥ —Å—ç–¥–≤–∏–π–≥ —Å–æ–Ω–≥–æ–Ω–æ

4. **–ë–æ–¥–ª–æ–≥–æ –æ—Ä—É—É–ª–∞—Ö**: ”®”©—Ä–∏–π–Ω –±–æ–¥–ª–æ–≥—ã–≥ –æ—Ä—É—É–ª–∞—Ö —ç—Å–≤—ç–ª "–ñ–∏—à—ç—ç–≥—ç—ç—Ä –¥“Ø“Ø—Ä–≥—ç—Ö" —Ç–æ–≤—á–∏–π–≥ –¥–∞—Ä–Ω–∞

5. **“Æ“Ø—Å–≥—ç—Ö**: "–ë–æ–¥–ª–æ–≥–æ “Ø“Ø—Å–≥—ç—Ö" —Ç–æ–≤—á–∏–π–≥ –¥–∞—Ä–∂ “Ø—Ä –¥“Ø–Ω–≥ —Ö–∞—Ä–∞—Ö

### –ß—É—Ö–∞–ª —Ç—ç–º–¥—ç–≥–ª—ç–ª“Ø“Ø–¥:

- **API —Ç“Ø–ª—Ö“Ø“Ø—Ä—ç—ç –Ω—É—É—Ü–ª–∞–∞—Ä–∞–π** - GitHub —Ä—É—É —Ö—ç–∑—ç—ç —á API —Ç“Ø–ª—Ö“Ø“Ø—Ä—ç—ç —à—É—É–¥ –æ—Ä—É—É–ª–∂ –±–æ–ª–æ—Ö–≥“Ø–π
- **–ë–æ–¥–ª–æ–≥–æ –æ—Ä—É—É–ª–∞—Ö–¥–∞–∞** –±“Ø—Ä—ç–Ω –¥“Ø“Ø—Ä—ç–Ω, –æ–π–ª–≥–æ–º–∂—Ç–æ–π –±–∞–π–ª–≥–∞—Ö –Ω—å –∏–ª“Ø“Ø —Å–∞–π–Ω “Ø—Ä –¥“Ø–Ω ”©–≥–Ω”©
- **–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä —Ç–æ—Ö–∏—Ä—É—É–ª–≥–∞** - ”®–Ω–¥”©—Ä temperature –∏–ª“Ø“Ø –±“Ø—Ç—ç—ç–ª—á –±–æ–ª–æ–≤—á –±–∞—Ç–∞–ª–≥–∞–∞–∂—Å–∞–Ω –±–∞–π–¥–∞–ª –±—É—É—Ä–Ω–∞
""")

# ------------------------------
# –•”©–ª —Ö—ç—Å—ç–≥
# ------------------------------
st.markdown("---")
st.caption("¬© 2023 –§–∏–∑–∏–∫/–ú–∞—Ç–µ–º–∞—Ç–∏–∫ –ë–æ–¥–ª–æ–≥–æ “Æ“Ø—Å–≥—ç–≥—á - Google Gemini AI –∞—à–∏–≥–ª–∞—Å–∞–Ω")

# –•—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω —Ç–æ—Ö–∏—Ä–≥–æ–æ–≥ —Ö–∞–¥–≥–∞–ª–∞—Ö
if google_api_key:
    st.session_state["api_key"] = google_api_key
